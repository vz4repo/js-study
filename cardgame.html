<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>card game</title>
		<link href="cardgame.css" rel="stylesheet" type="text/css" />
	</head>
	<body>
		<!--
    #   카드 뒤집고 완전같은 카드!
    
    ##  기능
    a. 시작버튼 활성/비활성 토글
    b. 감추기
    c. 뒤집기
    d. 섞기(감춘 상태? 뒤집은 상태?)

    ## flow
0.      카드 기본 세팅 (뒤면? 앞면?)
1.      한 카드를 뒤집는다
2.      다른 카드를 뒤집는다 (비교 시작)
3.0     색 같고, 숫자 같고, 타입 같다 (3가지)
3.1     파일명 같다 (1가지)
4.0     결과(다름) -> 둘다 다시 뒤집는다
4.1     결과(같음) -> 둘다 그대로
5.      종료되면 시작(비활성화) -> 시작(활성화)

    ## hint
img class:flipped를 추가해서 뒤집힌 카드에 대해서 표시를 하도록
-->
		<section id="buttons">
			<button class="button" id="btnStart" onclick="start()">시작</button>
			<button class="button" id="btnHide" onclick="hideAll()">감추기</button>
			<button class="button" id="btnFlip" onclick="flipAll()">뒤집기</button>
			<!-- <button class="button" id="btnShuffle" onclick="shuffle()">섞기</button> -->
		</section>
		<section id="playground"></section>
		<section id="scoreBoard"></section>

		<script>
			const playground = document.querySelector('#playground');
			const scoreBoard = document.querySelector('#scoreBoard');
			const CARDS_NUM = 52 - 1; // 카드 덱에 있는 수
			const PLAYGROUND_SIZE = 5; // 깔아주는 카드 갯수
			let quizSet = new Set(); // quizSet 선언+초기화
			let quizArr = []; // quizArr 선언+초기화
			let tmpString = ''; // innerHTML에 쓰일 임시 문자열 선언+초기화
			let imgPath = []; // addEventListener에 쓰일 NodeList 선언+초기화

			/* function: 초기화 */
			function init() {
				quizSet.clear();
				quizArr = [];
				tmpString = '';
				playground.innerHTML = '';
				cntPair = 0;
				cntSelected = 0;
				cntTry = 0;
			}
			/* function: 시작버튼 활성/비활성 토글 */
			function start() {
				// 1. 게임 시작 전 초기화( btn시작:활성화 )
				init();

				// 1.1 게임 시작 (섞고 - 모두 보여주고 - 모두 감추기)
				shuffle();
				addEvent();
				flipAll();
				hideAll();
				// setTimeout(hideAll(), 5000); // 왜안되는거야????

				// 2. 게임 중     (btn시작:비활성화, btn종료:활성화 )
				// 3. 게임 종료 후  (btn시작:활성화 )
			}
			/* function: 전체 감추기 */
			function hideAll() {
				let cardList = document.querySelectorAll('.card_img');
				// 모든 .card_img에 .flipped 제거
				cardList.forEach((item, index) => {
					item.classList.remove('flipped');
				});
			}
			/* function: 전체 뒤집기 */
			function flipAll() {
				let cardList = document.querySelectorAll('.card_img');
				// 모든 .card_img에 .flipped 추가
				cardList.forEach((item, index) => {
					item.classList.add('flipped');
				});
			}
			/* function: 감추기 */
			function hide() {
				document
					.querySelector('.card_img')
					.setAttribute('src', '/card_img/back.png');
			}
			/* function: 뒤집기 */
			function flip() {
				// 1. 하나 뒤집기
				// 2. 하나 이미 뒤집힌 상태에서 뒤집기
			}
			/* function: 비교하기 */
			// 1. 파일명(value) 비교
			function isEqual(a, b) {
				return a.attributes.src.value == b.attributes.src.value ? true : false;
			}

			/* function: 섞기(감춘 상태? 뒤집은 상태?) */
			function shuffle() {
				// 1. PLAYGROUND_SIZE 만큼의 quizSet에 랜덤값 넣기
				for (let i = 0; i < CARDS_NUM; i++) {
					quizSet.add(Math.floor(Math.random() * CARDS_NUM)); // 0 이상 CARDS_NUM 이하의 정수
					if (quizSet.size === PLAYGROUND_SIZE) break;
				}
				// 2. quizSet quizArr에 저장 2회
				quizArr = Array.from(quizSet);
				quizArr = quizArr.concat(quizArr);
				// 3. quizSet 무작위 정렬
				quizArr.sort(() => Math.random() - 0.5);
				// 4. quizArr 내용 저장
				for (card of quizArr) {
					tmpString += `<img class="card_img" src="/card_img/${card}.png" />`;
				}
				// 5. quizArr 출력
				playground.innerHTML = tmpString;
			}

			/* 각 img 태그에 addEventListener */
			function addEvent() {
				// 모든 img태그의 NodeList 가져오기
				imgPath = document.querySelectorAll('.card_img');

				// 각 img에 'click' 이벤트 추가
				imgPath.forEach((e) => {
					e.addEventListener('click', function () {
						getImageSrc(this); // 클릭된 이미지의 src
						if (cntPair === PLAYGROUND_SIZE) {
							scoreBoard.innerHTML = `<h1>끝!! | pair : [${cntPair}] | try : [${cntTry}]</h1>`;
						}
					});
				});
			}

			// let src; // test::
			let cntSelected = 0; // 선택된 카드 count
			let cntPair = 0; // 성공 count
			let cntTry = 0; // 시도 count

			let first; // 첫 선택 카드
			let second; // 두번째 선택 카드

			/* 클릭된 이미지의 src 출력 */
			function getImageSrc(item) {
				if (item.classList.contains('selected')) {
					// 대상에 .selected 존재의 경우
					item.classList.remove('selected'); // 같은걸 눌렀으니 .selected 제거
					cntSelected--;
				} else if (cntSelected === 2) {
					// 현재 선택된 대상 2개인 경우
					console.error('NO MORE SELECTION'); // 선택은 2개 이상 할 수 없다
				} else if (cntSelected === 0) {
					// 현재 선택된 대상 1개인 경우
					item.classList.add('selected'); // .selected 부여
					first = item; // first에 값 부여
					cntSelected++;
				} else {
					// .selected 부재의 경우
					item.classList.add('selected'); // .selected 부여
					second = item; // second에 값 부여
					cntSelected++;
				}

				// 2개 선택된 경우 isEqual(first,second) 호출
				if (cntSelected === 2) {
					// 각 카드 비교
					if (isEqual(first, second)) {
						// 같은 경우
						// .correct 부여. css에서 pointer-event 금지
						first.classList.add('correct');
						second.classList.add('correct');
						cntPair++;
					} else {
						// 다른 경우
					}
					// .selected 제거
					first.classList.remove('selected');
					second.classList.remove('selected');
					// 시도 count 갱신
					cntTry++;
					// 선택카드 count 초기화
					cntSelected = 0;
					// pair카드 count 갱신
					scoreBoard.innerHTML = `<h2>pair : [${cntPair}] | try : [${cntTry}]</h2>`;
				}
			}
		</script>
	</body>
</html>

<!-- 정답 pair는 clss:correct로 hidden -->
<!-- HELP 기능(몇장 랜덤 뒤집기) -->
<!-- 점수판(초단위) -->
<!-- 레코드(초단위, pair수) -->
